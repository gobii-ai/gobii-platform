{% extends "console_page.html" %}

{% block console_content %}
  <div x-data="billingSettings()" x-init="loadSettings()">
    <div class="hs-accordion-group bg-white/80 backdrop-blur-sm border border-white/60 shadow-xl rounded-xl overflow-hidden">
      <div class="px-6 py-3 border-gray-200/70 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
          <h1 class="text-2xl font-semibold text-gray-800">Billing</h1>
          <p class="text-sm text-gray-500 mt-1">Manage your subscription.</p>
        </div>
      </div>
    <div class="px-6 pb-6">
      <div class="flex flex-col space-y-4">
        <!-- Subscription Plan -->
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
          <div class="flex flex-col">
            <span class="text-sm font-medium text-gray-500">Subscription Plan</span>
            <span class="text-lg font-semibold text-gray-800">{{ subscription_plan.name }}</span>
          </div>
          <div class="mt-2 sm:mt-0">
            <!-- Replace with Preline Badge component -->
            <span class="inline-flex items-center py-1.5 px-3 rounded-full text-sm font-medium bg-blue-50 text-blue-700">
              ${{ subscription_plan.price|floatformat:2 }} {{ subscription_plan.currency }}/month
            </span>
          </div>
        </div>
        {% if paid_subscriber %}
          <!-- Divider -->
          <div class="border-t border-gray-100"></div>

          {% if cancel_at_period_end %}
          <!-- Cancellation Notice -->
          <div class="flex items-start">
            <div class="flex-shrink-0 mt-1">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
              </svg>
            </div>
            <div class="ml-3">
              <p class="text-sm font-medium text-red-600">Your subscription will be cancelled on</p>
              <p class="text-sm font-bold text-red-700 mt-1">{{ cancel_at }}</p>
            </div>
          </div>
          {% else %}
          <!-- Next Renewal Date -->
          <div class="flex items-start">
            <div class="flex-shrink-0 mt-1">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
              </svg>
            </div>
            <div class="ml-3">
              <p class="text-sm font-medium text-gray-500">{% if cancel_at_period_end %}Cancels on {% else %} Next Renewal {% endif %}</p>
              <p class="text-sm font-semibold text-gray-800 mt-1">{% if cancel_at_period_end %}{{ cancel_at }}{% else %}{{ period_end_date }}{% endif %}</p>
            </div>
          </div>

          <!-- Cancel Subscription Button (Only shown if not already cancelled) -->
          <div class="flex justify-end">
            <button type="button"
                    @click="showCancelModal = true"
                    class="py-2 px-4 inline-flex justify-center items-center gap-2 rounded-md border font-medium bg-white text-red-600 shadow-sm align-middle hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-all text-sm">
              <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
              Cancel Subscription
            </button>
          </div>
          {% endif %}

          <!-- Divider -->
          <div class="border-t border-gray-100"></div>

          <!-- Auto Purchase Extra Tasks Toggle -->
          <div class="flex flex-col space-y-3">
            <div class="flex items-center justify-between">
              <div>
                <span class="text-sm font-medium text-gray-700">Auto-purchase Extra Tasks</span>
                <p class="text-xs text-gray-500 mt-1">Allow automatic purchase of additional tasks when needed</p>
              </div>
              <!-- Replace with Preline Toggle component -->
              <div class="hs-toggle flex items-center">
                <input
                  type="checkbox"
                  id="auto-purchase-toggle"
                  class="relative w-[3.25rem] h-7 bg-gray-200 checked:bg-blue-600 rounded-full cursor-pointer transition-colors ease-in-out duration-200 border border-transparent ring-1 ring-transparent focus:border-blue-600 focus:ring-blue-600 ring-offset-white focus:outline-none appearance-none before:inline-block before:w-6 before:h-6 before:bg-white before:translate-x-0 checked:before:translate-x-full before:shadow before:rounded-full before:transform before:ring-0 before:transition before:ease-in-out before:duration-200"
                  x-model="enabled"
                  @change="saveSettings()"
                  {% if cancel_at_period_end %}disabled="disabled"{% endif %}
                >
                <label for="auto-purchase-toggle" class="sr-only">Enable auto-purchase</label>
              </div>
            </div>

            <!-- Extra Options (Only visible when toggle is enabled) -->
            <div x-show="enabled" x-transition class="pl-4 border-l-2 border-blue-100 space-y-3">
              <!-- Max Tasks Input - Using Preline form controls -->
              <div class="flex items-center space-x-2">
                <div class="flex items-center h-5">
                  <input
                    id="limited"
                    name="task_limit_type"
                    type="radio"
                    class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                    :checked="!infinite"
                    @click="infinite = false; saveSettings()"
                  >
                </div>
                <div class="flex items-center">
                  <label for="limited" class="text-sm font-medium text-gray-700 mr-2">Limit to</label>
                  <!-- Using Preline input component -->
                  <div class="hs-input-number w-20">
                    <input
                      type="number"
                      min="1"
                      max="10000"
                      x-model="maxTasks"
                      class="py-2 px-3 block w-full border-gray-300 rounded-md text-sm focus:border-blue-500 focus:ring-blue-500"
                      :disabled="infinite"
                      @change="saveSettings()"
                    >
                  </div>
                  <span class="ml-2 text-sm text-gray-600">extra tasks</span>
                </div>
              </div>

              <!-- Infinite Option -->
              <div class="flex items-center space-x-2">
                <div class="flex items-center h-5">
                  <input
                    id="infinite"
                    name="task_limit_type"
                    type="radio"
                    class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                    :checked="infinite"
                    @click="infinite = true; saveSettings()"
                  >
                </div>
                <label for="infinite" class="text-sm font-medium text-gray-700">Allow unlimited extra tasks</label>
              </div>
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Pure Tailwind + Alpine Modal - No Preline dependency -->
  <div x-show="showCancelModal"
       x-cloak
       class="fixed inset-0 z-50 overflow-y-auto"
       aria-labelledby="modal-title"
       role="dialog"
       aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
      <!-- Background overlay -->
      <div x-show="showCancelModal"
           x-transition:enter="ease-out duration-300"
           x-transition:enter-start="opacity-0"
           x-transition:enter-end="opacity-100"
           x-transition:leave="ease-in duration-200"
           x-transition:leave-start="opacity-100"
           x-transition:leave-end="opacity-0"
           class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"
           aria-hidden="true"
           @click="showCancelModal = false"></div>

      <!-- This element is to trick the browser into centering the modal contents. -->
      <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

      <!-- Modal panel -->
      <div x-show="showCancelModal"
           x-transition:enter="ease-out duration-300"
           x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
           x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
           x-transition:leave="ease-in duration-200"
           x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
           x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
           class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
          <div class="sm:flex sm:items-start">
            <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-amber-100 sm:mx-0 sm:h-10 sm:w-10">
              <!-- Warning icon -->
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-amber-600" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
              </svg>
            </div>
            <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
              <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                Cancel Subscription
              </h3>
              <div class="mt-2">
                <p class="text-sm text-gray-600">
                  Are you sure you want to cancel your subscription? Your subscription will remain active until <span class="font-semibold">{{ period_end_date }}</span>, after which it will be cancelled. You won't be billed again.
                </p>
                <p class="text-sm text-gray-600 mt-2">
                  You can resubscribe at any time.
                </p>
              </div>
            </div>
          </div>
        </div>
        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
          <button type="button"
                  id="confirm-cancel-subscription"
                  @click="cancelSubscription()"
                  class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">
            Cancel Subscription
          </button>
          <button type="button"
                  @click="showCancelModal = false"
                  class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
            Keep My Subscription
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function billingSettings() {
    return {
      enabled: false,
      infinite: false,
      maxTasks: 1000,
      showCancelModal: false,
      cancellationInProgress: false,

      loadSettings() {
        // Load the current settings from the server
        fetch('/api/v1/user/billing-settings/')
          .then(response => response.json())
          .then(data => {
            if (data.max_extra_tasks === -1) {
              this.enabled = true;
              this.infinite = true;
            } else if (data.max_extra_tasks > 0) {
              this.enabled = true;
              this.infinite = false;
              this.maxTasks = data.max_extra_tasks;
            } else {
              this.enabled = false;
              this.infinite = false;
              this.maxTasks = 1000; // Default value
            }
          })
          .catch(error => {
            console.error('Error loading billing settings:', error);
          });
      },

      saveSettings() {
        // Save the settings to the server
        fetch('/billing/settings/update/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': this.getCookie('csrftoken')
          },
          body: JSON.stringify({
            enabled: this.enabled,
            infinite: this.infinite,
            maxTasks: this.maxTasks
          })
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // Optional: Show a success message
              console.log('Settings saved successfully');
            } else {
              console.error('Error saving settings:', data.error);
            }
          })
          .catch(error => {
            console.error('Error saving settings:', error);
          });
      },

      cancelSubscription() {
        if (this.cancellationInProgress) return;

        this.cancellationInProgress = true;

        // Add a small loading state to the button
        const button = document.getElementById('confirm-cancel-subscription');
        const originalContent = button.innerHTML;
        button.innerHTML = '<svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Cancelling...';

        // Send the cancellation request to the server
        fetch('/billing/settings/cancel-subscription/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': this.getCookie('csrftoken')
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Reload the page to show the updated subscription status
            window.location.reload();
          } else {
            // Show error and reset button
            console.error('Error cancelling subscription:', data.error);
            button.innerHTML = originalContent;
            this.cancellationInProgress = false;
            this.showCancelModal = false;

            // Show an error alert
            alert('Error cancelling subscription: ' + (data.error || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('Error cancelling subscription:', error);
          button.innerHTML = originalContent;
          this.cancellationInProgress = false;
          this.showCancelModal = false;
          alert('Error cancelling subscription. Please try again later.');
        });
      },

      getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }
    };
  }
</script>
{% endblock %}