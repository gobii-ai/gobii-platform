{% extends "console_page.html" %}
{% load waffle_tags %}

{% block console_content %}
<div class="space-y-6 pb-6">
  <!-- Header -->
  <div class="bg-white/80 backdrop-blur-sm shadow-xl rounded-xl overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-200/70">
      <div>
        <h1 class="text-2xl font-semibold text-gray-800">Agent Configuration</h1>
        <p class="text-sm text-gray-500 mt-1">Manage your agent settings and preferences</p>
        <a href="{% url 'agents' %}" class="group flex items-center gap-2 text-sm text-blue-600 hover:text-blue-800 transition-colors mt-3">
          <svg class="w-4 h-4 group-hover:-translate-x-0.5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
          </svg>
          Back to Agents
        </a>
      </div>
    </div>
  </div>

  <!-- Configuration Card -->
  <div class="bg-white/80 backdrop-blur-sm border border-white/60 shadow-xl rounded-xl overflow-hidden">
    <div class="p-6 sm:p-8">
      <form method="post">
        {% csrf_token %}
        
        <!-- Grid Layout -->
        <div class="grid sm:grid-cols-12 gap-4 sm:gap-6">
          
          <!-- Agent Name Section -->
          <div class="sm:col-span-3">
            <label for="agent-name" class="inline-block text-sm font-medium text-gray-800 mt-2.5">
              Agent Name
            </label>
            <div class="hs-tooltip inline-block">
              <svg class="hs-tooltip-toggle ms-1 inline-block size-3 text-gray-400" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
              </svg>
              <span class="hs-tooltip-content hs-tooltip-shown:opacity-100 hs-tooltip-shown:visible opacity-0 transition-opacity inline-block absolute invisible w-40 text-center z-10 py-1 px-2 bg-gray-900 text-xs font-medium text-white rounded-md shadow-sm" role="tooltip">
                Display name for your agent
              </span>
            </div>
          </div>
          
          <div class="sm:col-span-9">
            <input id="agent-name" name="name" type="text" value="{{ agent.name }}" 
                   class="py-2 px-3 block w-full border-gray-200 shadow-sm rounded-lg text-sm focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none">
            <p class="mt-2 text-xs text-gray-500">Choose a memorable name for your agent that describes its purpose.</p>
          </div>

          {% flag "organizations" %}
          <!-- Ownership Section (organizations feature only) -->
          <div class="sm:col-span-3">
            <label for="agent-ownership" class="inline-block text-sm font-medium text-gray-800 mt-2.5">
              Ownership
            </label>
            <div class="hs-tooltip inline-block">
              <svg class="hs-tooltip-toggle ms-1 inline-block size-3 text-gray-400" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
              </svg>
              <span class="hs-tooltip-content hs-tooltip-shown:opacity-100 hs-tooltip-shown:visible opacity-0 transition-opacity inline-block absolute invisible w-56 text-center z-10 py-1 px-2 bg-gray-900 text-xs font-medium text-white rounded-md shadow-sm" role="tooltip">
                Assign this agent to one of your organizations. Requires owner/admin role.
              </span>
            </div>
          </div>
          <div class="sm:col-span-9">
            {% if agent.organization %}
              <div class="flex items-center gap-3">
                <span class="text-sm text-gray-700">Currently assigned to <strong>{{ agent.organization.name }}</strong></span>
                <button type="button" id="move-personal-btn" class="px-3 py-1.5 text-sm bg-gray-600 text-white rounded-lg hover:bg-gray-700">Move to Personal</button>
              </div>
            {% else %}
              <div class="flex items-center gap-2">
                <select id="target-org-id" class="py-2 border-gray-200 rounded-lg text-sm focus:border-blue-500 focus:ring-blue-500">
                  <option value="">Select organizationâ€¦</option>
                  {% for org in reassignable_orgs %}
                    <option value="{{ org.id }}">{{ org.name }}</option>
                  {% endfor %}
                </select>
                <button type="button" id="assign-org-btn" class="px-3 py-1.5 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700">Assign to Organization</button>
              </div>
              <p class="mt-2 text-xs text-gray-500">Name must be unique within the selected organization.</p>
            {% endif %}
            <div id="ownership-error" class="mt-2 text-xs text-red-600 hidden"></div>
          </div>
          {% endflag %}

          <!-- Agent Email Section -->
          {% if primary_email %}
          <div class="sm:col-span-3">
            <label for="agent-email" class="inline-block text-sm font-medium text-gray-800 mt-2.5">
              Primary Email
            </label>
          </div>
          
          <div class="sm:col-span-9">
            <input id="agent-email" name="email" type="text" value="{{ primary_email.address }}"
                   class="py-2 px-3 block w-full border-gray-200 bg-gray-100 shadow-sm rounded-lg text-sm focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none"
                   disabled>
            <p class="mt-2 text-xs text-gray-500">The agent's primary email address for communication.</p>
            <div class="mt-2">
              <a href="{% url 'agent_email_settings' agent.id %}"
                 class="text-sm text-blue-600 hover:text-blue-800">Manage Email Settings</a>
            </div>
            {% if not primary_sms %}
            <div class="mt-2">
              <a href="{% url 'agent_enable_sms' agent.id %}"
                 class="text-sm text-blue-600 hover:text-blue-800">Enable SMS</a>
            </div>
            {% endif %}
          </div>
          {% endif %}
          {% if not primary_email %}
          <div class="sm:col-span-3">
            <label class="inline-block text-sm font-medium text-gray-800 mt-2.5">
              Primary Email
            </label>
          </div>
          <div class="sm:col-span-9">
            <div class="py-2 px-3 text-sm text-gray-600 bg-gray-50 border border-dashed border-gray-300 rounded">
              Not configured. <a href="{% url 'agent_email_settings' agent.id %}" class="text-blue-600 hover:text-blue-800">Set up email</a>
            </div>
          </div>
          {% endif %}

          <!-- Agent Phone Section -->
          {% if primary_sms %}
          <div class="sm:col-span-3">
            <label for="agent-sms" class="inline-block text-sm font-medium text-gray-800 mt-2.5">
              Primary SMS
            </label>
          </div>

          <div class="sm:col-span-9">
            <input id="agent-sms" name="sms" type="text" value="{{ primary_sms.address }}"
                   class="phone-number-to-format py-2 px-3 block w-full border-gray-200 bg-gray-100 shadow-sm rounded-lg text-sm focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none"
                   disabled>
            <p class="mt-2 text-xs text-gray-500">The agent's primary SMS address for communication. This cannot be changed.</p>
          </div>
          {% endif %}

          <!-- Agent Status Section -->
          <div class="sm:col-span-3">
            <label class="inline-block text-sm font-medium text-gray-800 mt-2.5">
              Status
            </label>
          </div>
          
          <div class="sm:col-span-9">
            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg bg-gray-50/50">
              <div class="flex items-center gap-3">
                <div class="flex items-center justify-center w-10 h-10 rounded-full {% if agent.is_active %}bg-green-100{% else %}bg-gray-100{% endif %}">
                  {% if agent.is_active %}
                    <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                  {% else %}
                    <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"/>
                    </svg>
                  {% endif %}
                </div>
                <div>
                  <p class="text-sm font-medium text-gray-800">
                    {% if agent.is_active %}Active{% else %}Inactive{% endif %}
                  </p>
                  <p class="text-xs text-gray-500">
                    {% if agent.is_active %}Your agent is currently running and accepting tasks{% else %}Your agent is paused and not accepting tasks{% endif %}
                  </p>
                </div>
              </div>
              
              <!-- Toggle Switch -->
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" name="is_active" {% if agent.is_active %}checked{% endif %}
                       class="sr-only peer">
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
              </label>
            </div>
            <p class="mt-2 text-xs text-gray-500">Use this switch to activate or pause the agent. Click "Save Changes" to apply.</p>
          </div>

          <!-- Assignment -->
          <div class="sm:col-span-3">
            <label for="agent-charter" class="inline-block text-sm font-medium text-gray-800 mt-2.5">
              Assignment
            </label>
            <div class="hs-tooltip inline-block">
              <svg class="hs-tooltip-toggle ms-1 inline-block size-3 text-gray-400" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
              </svg>
              <span class="hs-tooltip-content hs-tooltip-shown:opacity-100 hs-tooltip-shown:visible opacity-0 transition-opacity inline-block absolute invisible w-40 text-center z-10 py-1 px-2 bg-gray-900 text-xs font-medium text-white rounded-md shadow-sm" role="tooltip">
                Describe what you want your agent to do
              </span>
            </div>
          </div>
          
          <div class="sm:col-span-9">
            <textarea id="agent-charter" name="charter" rows="4" 
                      class="py-2 px-3 block w-full border-gray-200 shadow-sm rounded-lg text-sm focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none"
                      placeholder="Describe what you want your agent to do...">{{ agent.charter }}</textarea>
            <p class="mt-2 text-xs text-gray-500">Describe your agent's role, responsibilities, and any specific tasks or goals it should focus on.</p>
          </div>
          
          <!-- Allowed Contacts Section (only shown with multiplayer_agents flag) -->
          {% if show_allowlist %}
          <div class="sm:col-span-3">
            <label for="allowed-contacts" class="inline-block text-sm font-medium text-gray-800 mt-2.5">
              Allowed Contacts
            </label>
            <div class="hs-tooltip inline-block">
              <svg class="hs-tooltip-toggle ms-1 inline-block size-3 text-gray-400" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
              </svg>
              <span class="hs-tooltip-content hs-tooltip-shown:opacity-100 hs-tooltip-shown:visible opacity-0 transition-opacity inline-block absolute invisible w-48 text-center z-10 py-1 px-2 bg-gray-900 text-xs font-medium text-white rounded-md shadow-sm" role="tooltip">
                Controls who can message this agent and who the agent may contact
              </span>
            </div>
          </div>
          
          <div class="sm:col-span-9">
            <!-- Hidden field to maintain MANUAL policy -->
            <input type="hidden" name="whitelist_policy" value="manual">
            
            <p class="text-xs text-gray-500 mb-4">
              By default, the agent owner and organization members can communicate with this agent.
              You can add additional contacts below. Note: Multi-recipient messaging is limited to email only.
            </p>
            
            <!-- Allowed contacts entries (always visible now) -->
            <div id="allowlist-entries" class="mt-4">
              
              <!-- Add Entry Form -->
              <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg mb-3">
                <h4 class="text-sm font-medium text-gray-700 mb-2">Add Allowed Contact</h4>
                <div id="add-allowlist-form" class="space-y-2">
                  {% csrf_token %}
                  <div class="flex gap-2">
                    <select id="allowlist-channel" name="channel" class="py-1.5 text-sm border-gray-300 rounded-lg focus:border-blue-500 focus:ring-blue-500">
                      <option value="email">Email</option>
                      <!-- SMS option removed since multi-player agents only support email -->
                    </select>
                    <input type="email" 
                           id="allowlist-address"
                           name="address" 
                           placeholder="email@example.com" 
                           class="flex-1 py-1.5 px-2 text-sm border-gray-300 rounded-lg focus:border-blue-500 focus:ring-blue-500">
                  </div>
                  <div class="flex gap-4 items-center">
                    <label class="flex items-center gap-1 text-sm">
                      <input type="checkbox" id="allow-inbound" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                      <span>Allow Inbound</span>
                      <span class="text-xs text-gray-500">(can send to agent)</span>
                    </label>
                    <label class="flex items-center gap-1 text-sm">
                      <input type="checkbox" id="allow-outbound" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                      <span>Allow Outbound</span>
                      <span class="text-xs text-gray-500">(agent can send to)</span>
                    </label>
                  </div>
                  <div class="flex gap-2">
                    <button type="button" 
                            onclick="addAllowlistEntry()"
                            class="px-3 py-1.5 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                      Add
                    </button>
                    <button type="button" 
                            onclick="cancelAllowlistEntry()"
                            class="px-3 py-1.5 text-sm bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                      Cancel
                    </button>
                  </div>
                </div>
                <div id="allowlist-error" class="mt-2 text-xs text-red-600 hidden"></div>
              </div>

              <!-- Pending Contact Requests Alert -->
              {% if pending_contact_requests > 0 %}
              <div class="p-3 bg-yellow-50 border border-yellow-200 rounded-lg mb-3">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span class="text-sm font-medium text-yellow-800">
                      {{ pending_contact_requests }} Contact Request{{ pending_contact_requests|pluralize }} Pending
                    </span>
                  </div>
                  <a href="{% url 'agent_contact_requests' agent.id %}" class="text-sm font-medium text-yellow-700 hover:text-yellow-900 underline">
                    Review
                  </a>
                </div>
              </div>
              {% endif %}

              <!-- Current Entries List -->
              <div class="p-3 bg-gray-50 rounded-lg">
                <div class="flex justify-between items-center mb-2">
                  <h4 class="text-sm font-medium text-gray-700">Allowed Contacts</h4>
                  <span class="text-xs text-gray-500">
                    <span id="contact-count">{{ active_allowlist_count }}</span> / {{ max_contacts_per_agent|default:account.usage.max_contacts_per_agent }} contacts
                  </span>
                </div>
                <div id="allowlist-entries-container">
                  {% include "console/partials/_allowlist_entries_inline.html" %}
                </div>
              </div>
            </div>
          </div>
          {% endif %}

          <!-- Created Date -->
          <div class="sm:col-span-3">
            <label class="inline-block text-sm font-medium text-gray-800 mt-2.5">
              Created
            </label>
          </div>
          
          <div class="sm:col-span-9">
            <div class="py-2 px-3 text-sm text-gray-600">
              {{ agent.created_at|date:"F j, Y \a\\t g:i A" }}
            </div>
          </div>

        </div>

        <!-- Action Buttons -->
        <div class="mt-8 pt-6 border-t border-gray-200 flex justify-end gap-x-3">
          <a href="{% url 'agents' %}"
             class="py-2 px-4 inline-flex items-center gap-x-2 text-sm font-medium rounded-lg border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-50 transition-colors">
            Cancel
          </a>
          <a href="{% url 'agent_chat_shell' pk=agent.id %}"
             target="_blank"
             rel="noopener noreferrer"
             class="py-2 px-4 inline-flex items-center gap-x-2 text-sm font-medium rounded-lg border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-50 transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h8M8 14h5M5 6h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-4 3-1-3H5a2 2 0 01-2-2V8a2 2 0 012-2z"/>
            </svg>
            Open Web Chat
          </a>
          <a href="{% url 'agent_secrets' agent.id %}"
             class="py-2 px-4 inline-flex items-center gap-x-2 text-sm font-medium rounded-lg border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-50 transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1721 9z"/>
            </svg>
            Manage Secrets
          </a>
          <a href="{% url 'agent_email_settings' agent.id %}"
             class="py-2 px-4 inline-flex items-center gap-x-2 text-sm font-medium rounded-lg border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-50 transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12a4 4 0 10-8 0 4 4 0 008 0z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 2v2m0 16v2m10-10h-2M4 12H2m15.364 6.364l-1.414-1.414M6.05 6.05L4.636 4.636m12.728 0l-1.414 1.414M6.05 17.95l-1.414 1.414" />
            </svg>
            Manage Email
          </a>
          <button type="submit" 
                  class="py-2 px-4 inline-flex items-center gap-x-2 text-sm font-medium rounded-lg border border-transparent bg-blue-600 text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            Save Changes
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Danger Zone -->
  <div class="bg-white/80 backdrop-blur-sm border border-red-200/60 shadow-xl rounded-xl overflow-hidden">
    <div class="p-6 sm:p-8">
      <div class="flex gap-x-4">
        <!-- Warning Icon -->
        <div class="flex-shrink-0">
          <div class="flex items-center justify-center w-12 h-12 rounded-full bg-red-100 border-4 border-red-50">
            <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
            </svg>
          </div>
        </div>
        
        <div class="flex-grow">
          <h3 class="text-lg font-bold text-red-800 mb-2">Danger Zone</h3>
          <p class="text-sm text-red-700 mb-6">
            Permanently delete this agent and all of its data. This action cannot be undone and will immediately stop any running tasks.
          </p>
          
          <!-- Delete Button -->
          <button hx-delete="{% url 'agent_delete' agent.id %}" 
                  hx-confirm="Are you sure you want to delete this agent? This action cannot be undone and will permanently remove all agent data and stop any running tasks."
                  hx-target="body" 
                  hx-swap="none"
                  class="py-2 px-4 inline-flex items-center gap-x-2 text-sm font-medium rounded-lg border border-red-300 bg-red-50 text-red-700 hover:bg-red-100 hover:border-red-400 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
            Delete Agent
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript to handle allowlist management -->
{% if show_allowlist %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Removed policy dropdown handling - all agents now use manual mode
    // Ownership reassignment handlers
    const assignBtn = document.getElementById('assign-org-btn');
    const movePersonalBtn = document.getElementById('move-personal-btn');
    const ownershipError = document.getElementById('ownership-error');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;

    async function postReassign(targetOrgId) {
        if (!csrfToken) {
            if (ownershipError) {
                ownershipError.textContent = 'Security token missing. Please refresh the page.';
                ownershipError.classList.remove('hidden');
            }
            return;
        }

        const formData = new FormData();
        formData.append('action', 'reassign_org');
        formData.append('csrfmiddlewaretoken', csrfToken);
        if (targetOrgId) formData.append('target_org_id', targetOrgId);

        try {
            const resp = await fetch('{% url "agent_detail" agent.id %}', {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            const data = await resp.json();
            if (data?.success) {
                if (data.redirect) {
                    window.location = data.redirect;
                } else {
                    window.location.reload();
                }
                return;
            }
            const err = data?.error || 'Reassignment failed.';
            if (ownershipError) {
                ownershipError.textContent = err;
                ownershipError.classList.remove('hidden');
            } else {
                alert(err);
            }
        } catch (e) {
            if (ownershipError) {
                ownershipError.textContent = 'An error occurred. Please try again.';
                ownershipError.classList.remove('hidden');
            } else {
                alert('An error occurred. Please try again.');
            }
        }
    }

    if (assignBtn) {
        assignBtn.addEventListener('click', function() {
            const sel = document.getElementById('target-org-id');
            const target = sel ? sel.value : '';
            if (!target) {
                if (ownershipError) {
                    ownershipError.textContent = 'Please select an organization.';
                    ownershipError.classList.remove('hidden');
                }
                return;
            }
            postReassign(target);
        });
    }

    if (movePersonalBtn) {
        movePersonalBtn.addEventListener('click', function() {
            postReassign(null);
        });
    }
    
});

// Function to add allowlist entry
function addAllowlistEntry() {
    const channel = document.getElementById('allowlist-channel').value;
    const address = document.getElementById('allowlist-address').value;
    const errorDiv = document.getElementById('allowlist-error');
    
    // Check if required elements exist
    if (!channel || !address || !errorDiv) {
        console.error('Required elements not found');
        return;
    }
    
    if (!address) {
        errorDiv.textContent = 'Please enter an email address';
        errorDiv.classList.remove('hidden');
        return;
    }
    
    // Get CSRF token from the page
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token }}';
    
    if (!csrfToken) {
        console.error('CSRF token not found');
        errorDiv.textContent = 'Security token missing. Please refresh the page.';
        errorDiv.classList.remove('hidden');
        return;
    }
    
    // Get inbound/outbound settings
    const allowInbound = document.getElementById('allow-inbound').checked;
    const allowOutbound = document.getElementById('allow-outbound').checked;
    
    const formData = new FormData();
    formData.append('action', 'add_allowlist');
    formData.append('channel', channel);
    formData.append('address', address);
    formData.append('allow_inbound', allowInbound);
    formData.append('allow_outbound', allowOutbound);
    formData.append('csrfmiddlewaretoken', csrfToken);
    
    fetch('{% url "agent_detail" agent.id %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        console.log('Response status:', response.status);
        return response.json();  // Parse JSON even if not ok to get error message
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.success) {
            // Update the entries list
            document.getElementById('allowlist-entries-container').innerHTML = data.html;
            // Clear the form
            document.getElementById('allowlist-address').value = '';
            // Hide error message
            errorDiv.classList.add('hidden');
            // Update contact count
            if (data.active_count !== undefined) {
                document.getElementById('contact-count').textContent = data.active_count;
            }
        } else {
            // Show error message
            errorDiv.textContent = data.error || 'Failed to add entry';
            errorDiv.classList.remove('hidden');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        errorDiv.textContent = 'An error occurred. Please try again.';
        errorDiv.classList.remove('hidden');
    });
}

// Function to cancel allowlist entry form
function cancelAllowlistEntry() {
    // Clear the form
    document.getElementById('allowlist-address').value = '';
    // Reset checkboxes to default (both checked)
    document.getElementById('allow-inbound').checked = true;
    document.getElementById('allow-outbound').checked = true;
    // Hide any error messages
    const errorDiv = document.getElementById('allowlist-error');
    if (errorDiv) {
        errorDiv.classList.add('hidden');
        errorDiv.textContent = '';
    }
}

// Function to cancel an invitation
function cancelInvite(inviteId) {
    if (!confirm('Cancel this invitation?')) {
        return;
    }
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
    if (!csrfToken) {
        alert('Security token missing. Please refresh the page.');
        return;
    }
    
    const formData = new FormData();
    formData.append('action', 'cancel_invite');
    formData.append('invite_id', inviteId);
    formData.append('csrfmiddlewaretoken', csrfToken);
    
    fetch('{% url "agent_detail" agent.id %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the entries list
            document.getElementById('allowlist-entries-container').innerHTML = data.html;
            // Update contact count
            if (data.active_count !== undefined) {
                document.getElementById('contact-count').textContent = data.active_count;
            }
        } else {
            alert(data.error || 'Failed to cancel invitation');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
    });
}

// Function to remove allowlist entry
function removeAllowlistEntry(entryId) {
    if (!confirm('Remove this contact from the allowlist?')) {
        return;
    }
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
    if (!csrfToken) {
        alert('Security token missing. Please refresh the page.');
        return;
    }
    
    const formData = new FormData();
    formData.append('action', 'remove_allowlist');
    formData.append('entry_id', entryId);
    formData.append('csrfmiddlewaretoken', csrfToken);
    
    fetch('{% url "agent_detail" agent.id %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the entries list
            document.getElementById('allowlist-entries-container').innerHTML = data.html;
            // Update contact count
            if (data.active_count !== undefined) {
                document.getElementById('contact-count').textContent = data.active_count;
            }
        } else {
            alert(data.error || 'Failed to remove entry');
        }
    })
    .catch(error => {
        alert('An error occurred. Please try again.');
    });
}
</script>
{% endif %}

{% endblock %} 
