{% load agent_extras %}
{% load humanize %}
{% load tz %}

{% for event in events %}
  {% with message=event.message step=event.step %}
    <article class="timeline-event rounded-xl border border-slate-200/80 bg-white px-4 py-4 shadow-sm shadow-slate-200/60" data-cursor="{{ event.cursor }}">
      {% if message %}
        {% with endpoint=message.to_endpoint|default:message.from_endpoint %}
          <header class="flex flex-wrap items-center justify-between gap-2 text-xs text-slate-500">
            <div class="flex items-center gap-2">
              <span class="font-semibold text-slate-600 uppercase tracking-wide">{{ endpoint.channel|channel_label }}</span>
              <span class="text-slate-400">•</span>
              <span>{% if message.is_outbound %}Sent to {{ message.to_endpoint.address|default:"recipient" }}{% else %}Received from {{ message.from_endpoint.address|default:"contact" }}{% endif %}</span>
            </div>
            <time datetime="{{ event.timestamp|date:'c' }}" class="text-slate-400">{{ event.timestamp|date:"M j, g:i a" }} · {{ event.timestamp|timesince }} ago</time>
          </header>

          <div class="mt-3 prose prose-sm max-w-none break-words text-slate-800">
            {{ message.body|agent_markdown }}
          </div>

          {% if message.latest_status %}
            <p class="mt-3 text-xs text-slate-400 uppercase">Status: {{ message.latest_status|title }}</p>
          {% endif %}

          {% with attachments=message.attachments.all %}
            {% if attachments %}
              <ul class="mt-3 space-y-1 text-xs text-slate-500">
                {% for attachment in attachments %}
                  <li class="flex items-center gap-2">
                    <svg class="h-3.5 w-3.5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.415-6.414a4 4 0 10-5.657-5.657l-6.415 6.414" />
                    </svg>
                    <span class="truncate">{{ attachment.filename }}</span>
                    <span class="text-slate-400">({{ attachment.file_size|filesizeformat }})</span>
                  </li>
                {% endfor %}
              </ul>
            {% endif %}
          {% endwith %}
        {% endwith %}
      {% elif step %}
        <header class="flex flex-wrap items-center justify-between gap-2 text-xs text-slate-500">
          <div class="font-semibold text-slate-600">Agent step</div>
          <time datetime="{{ event.timestamp|date:'c' }}" class="text-slate-400">{{ event.timestamp|date:"M j, g:i a" }} · {{ event.timestamp|timesince }} ago</time>
        </header>

        {% if step.description %}
          <p class="mt-2 whitespace-pre-line text-sm text-slate-700 break-words">{{ step.description }}</p>
        {% endif %}

        <dl class="mt-3 flex flex-wrap gap-4 text-xs text-slate-500">
          {% if step.llm_model %}
            <div><dt class="font-semibold text-slate-600">Model</dt><dd>{{ step.llm_model }}</dd></div>
          {% endif %}
          {% if step.prompt_tokens and step.total_tokens %}
            <div><dt class="font-semibold text-slate-600">Tokens</dt><dd>{{ step.total_tokens|intcomma }}</dd></div>
          {% endif %}
        </dl>

        {% if step.tool_call %}
          <div class="mt-3 space-y-2 rounded-lg border border-slate-200 bg-slate-50 p-3 text-xs text-slate-600">
            <div class="font-semibold text-slate-600">Tool · {{ step.tool_call.tool_name }}</div>
            {% if step.tool_call.tool_params %}
              <div>
                <p class="mb-1 font-medium text-slate-500">Parameters</p>
                <pre class="max-h-48 overflow-auto rounded bg-slate-900/90 p-2 text-[11px] text-slate-100">{{ step.tool_call.tool_params|pretty_json }}</pre>
              </div>
            {% endif %}
            {% if step.tool_call.result %}
              <div>
                <p class="mb-1 font-medium text-slate-500">Result</p>
                <div class="max-h-48 overflow-auto rounded bg-white p-2 text-[11px] text-slate-700 whitespace-pre-wrap">{{ step.tool_call.result }}</div>
              </div>
            {% endif %}
          </div>
        {% endif %}
      {% endif %}
    </article>
  {% endwith %}
{% empty %}
  <div class="text-center text-sm text-slate-400">No activity yet.</div>
{% endfor %}
