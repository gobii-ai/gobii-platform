{% url 'console-mcp-server-create' as default_form_action %}
{% url 'console-mcp-oauth-start' as oauth_start_url %}
{% url 'console-mcp-oauth-metadata' as oauth_metadata_url %}
{% url 'console-mcp-oauth-callback-view' as oauth_callback_path %}
{% with modal_id=modal_id|default:'create-mcp-server-modal' form_id=form_id|default:'create-mcp-server-form' form_action=form_action|default:default_form_action form_target=form_target|default:'#mcp-server-result' %}
<form
  id="{{ form_id }}"
  hx-post="{{ form_action }}"
  hx-target="{{ form_target }}"
  hx-swap="innerHTML"
  hx-on::after-request="
      const triggerHeader = event.detail.xhr ? event.detail.xhr.getResponseHeader('HX-Trigger') : null;
      if (event.detail.successful && triggerHeader && triggerHeader.includes('refreshMcpServersTable')) {
        window.dispatchEvent(new CustomEvent('close-modal', { detail: { id: '{{ modal_id }}' } }));
      }
  "
  data-server-id="{{ form.instance.id|default:'' }}"
  data-oauth-start-url="{{ oauth_start_url }}"
  data-oauth-metadata-url="{{ oauth_metadata_url }}"
  data-oauth-callback-path="{{ oauth_callback_path }}"
  data-oauth-status-url="{% if form.instance and form.instance.id %}{% url 'console-mcp-oauth-status' form.instance.id %}{% endif %}"
  data-oauth-revoke-url="{% if form.instance and form.instance.id %}{% url 'console-mcp-oauth-revoke' form.instance.id %}{% endif %}"
  data-oauth-url-field-id="{{ form.url.id_for_label }}"
  x-data="{
      displayName: '{{ form.display_name.value|default:''|escapejs }}',
      slug: '{{ form.name.value|default:''|escapejs }}',
      headers: [],
      authMethodValue: '{{ form.auth_method.value|default:form.fields.auth_method.initial|default:'none' }}',
      oauthClientId: '',
      oauthClientSecret: '',
      oauthScope: '',
      oauth: null,
      init() {
        if (!this.slug && this.displayName) {
          this.slug = this.slugify(this.displayName);
        }
        this.headers = this.loadHeaders();
        this.ensureHeaderRows();
        this.syncHeadersField();
        this.queueIconRefresh();
        if (window.createMCPOAuthStore) {
          this.oauth = window.createMCPOAuthStore(this.$el.dataset);
          if (this.oauth) {
            this.oauth.mount({
              getServerUrl: () => this.$refs.serverUrl ? this.$refs.serverUrl.value || '' : '',
              getClientId: () => this.oauthClientId.trim(),
              getClientSecret: () => this.oauthClientSecret.trim(),
              getScope: () => this.oauthScope.trim(),
            });
            this.oauth.setAuthMethod(this.authMethodValue);
          }
        }
        this.$watch('authMethodValue', (value) => {
          if (this.oauth) {
            this.oauth.setAuthMethod(value);
          }
        });
      },
      slugify(value) {
        if (!value) { return ''; }
        const normalized = value.toString().normalize('NFKD').replace(/[\u0300-\u036f]/g, '');
        return normalized
          .toLowerCase()
          .replace(/[^a-z0-9\s-]/g, '')
          .trim()
          .replace(/[\s_-]+/g, '-')
          .replace(/^-+|-+$/g, '')
          .slice(0, 64);
      },
      loadHeaders() {
        const field = this.$refs.headersField;
        if (!field || !field.value) { return []; }
        try {
          const parsed = JSON.parse(field.value);
          if (!parsed || typeof parsed !== 'object' || Array.isArray(parsed)) {
            return [];
          }
          return Object.entries(parsed).map(([key, value]) => ({
            key: key == null ? '' : String(key),
            value: value == null ? '' : String(value),
          }));
        } catch (error) {
          console.warn('Invalid headers JSON', error);
          return [];
        }
      },
      ensureHeaderRows() {
        if (!this.headers.length) {
          this.headers.push({ key: '', value: '' });
          this.queueIconRefresh();
        }
      },
      addHeaderRow() {
        this.headers.push({ key: '', value: '' });
        this.syncHeadersField();
        this.queueIconRefresh();
      },
      removeHeaderRow(index) {
        this.headers.splice(index, 1);
        this.ensureHeaderRows();
        this.syncHeadersField();
        this.queueIconRefresh();
      },
      syncHeadersField() {
        const field = this.$refs.headersField;
        if (!field) { return; }
        const headersObject = {};
        for (const entry of this.headers) {
          const headerKey = (entry.key || '').trim();
          if (!headerKey) {
            continue;
          }
          headersObject[headerKey] = entry.value == null ? '' : String(entry.value);
        }
        field.value = JSON.stringify(headersObject);
      },
      queueIconRefresh() {
        this.$nextTick(() => this.refreshIcons());
      },
      refreshIcons() {
        if (window.lucide && typeof window.lucide.createIcons === 'function') {
          window.lucide.createIcons({ nameAttr: 'data-lucide' });
        }
      }
  }"
  class="space-y-6"
>

  {% csrf_token %}
  {{ form.name }}

  {% if form.non_field_errors %}
    <div class="rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700">
      {% for error in form.non_field_errors %}
        <p>{{ error }}</p>
      {% endfor %}
    </div>
  {% endif %}

  <div class="grid sm:grid-cols-2 gap-4">
    <div class="sm:col-span-2 space-y-1">
      <label class="block text-sm font-medium text-gray-700" for="{{ form.display_name.id_for_label }}">Display Name</label>
      {{ form.display_name }}
      <p class="text-xs text-gray-500">Identifier: <span x-text="slug || 'auto-generated'" class="font-mono text-gray-600"></span></p>
      {% for error in form.display_name.errors %}
        <p class="text-xs text-red-600">{{ error }}</p>
      {% endfor %}
    </div>

    <div class="sm:col-span-2">
      <label class="flex items-center gap-2 text-sm font-medium text-gray-700" for="{{ form.is_active.id_for_label }}">
        {{ form.is_active }}
        <span>Active</span>
      </label>
      <p class="text-xs text-gray-500 mt-1">Inactive servers remain configured but hidden from agents.</p>
      {% for error in form.is_active.errors %}
        <p class="text-xs text-red-600 mt-1">{{ error }}</p>
      {% endfor %}
    </div>

    <div class="sm:col-span-2 space-y-2">
      <div>
        <label class="block text-sm font-medium text-gray-700" for="{{ form.auth_method.id_for_label }}">Authentication</label>
        {{ form.auth_method }}
        {% if form.auth_method.help_text %}
          <p class="text-xs text-gray-500">{{ form.auth_method.help_text }}</p>
        {% endif %}
        {% for error in form.auth_method.errors %}
          <p class="text-xs text-red-600">{{ error }}</p>
        {% endfor %}
      </div>

      <template x-if="authMethodValue === 'oauth2'">
        <div class="rounded-lg border border-indigo-200 bg-indigo-50 p-4 space-y-4">
          <div class="flex items-center gap-2">
            <i data-lucide="link" class="h-4 w-4 text-indigo-500"></i>
            <p class="text-sm font-medium text-indigo-700">OAuth Connection</p>
          </div>
          <div class="space-y-3 text-sm text-indigo-900">
            <template x-if="!oauth || !oauth.hasServer">
              <p>Save this MCP server first, then return to connect via OAuth 2.0.</p>
            </template>
            <template x-if="oauth && oauth.hasServer">
              <div class="space-y-2">
                <p x-show="oauth && oauth.status === 'connected'">
                  Connected • <span class="font-mono" x-text="oauth.scope || 'default scope'"></span>
                </p>
                <p x-show="oauth && oauth.status === 'pending'">
                  Pending authorization. Complete the OAuth flow in the other tab to finish setup.
                </p>
                <p x-show="oauth && oauth.status === 'disconnected'">
                  Not connected. Use the fields below and click connect to begin the OAuth flow.
                </p>
              </div>
            </template>
          </div>
          <div class="space-y-3" x-cloak x-show="oauth && oauth.hasServer">
            <div class="grid gap-3 sm:grid-cols-2">
              <div class="space-y-1">
                <label class="text-xs font-medium text-indigo-700">OAuth Client ID</label>
                <input type="text" class="py-2 px-3 block w-full border-indigo-200 rounded-md focus:border-indigo-400 focus:ring-indigo-400 text-sm" placeholder="client-id" x-model="oauthClientId">
              </div>
              <div class="space-y-1">
                <label class="text-xs font-medium text-indigo-700">OAuth Client Secret</label>
                <input type="password" class="py-2 px-3 block w-full border-indigo-200 rounded-md focus:border-indigo-400 focus:ring-indigo-400 text-sm" placeholder="Optional" x-model="oauthClientSecret">
              </div>
            </div>
            <div class="space-y-1">
              <label class="text-xs font-medium text-indigo-700">Scopes</label>
              <input type="text" class="py-2 px-3 block w-full border-indigo-200 rounded-md focus:border-indigo-400 focus:ring-indigo-400 text-sm" placeholder="e.g. openid profile email" x-model="oauthScope">
              <p class="text-xs text-indigo-600">Separate scopes with spaces. Leave blank for provider defaults.</p>
            </div>
            <div class="flex flex-wrap gap-3">
              <button
                type="button"
                class="inline-flex items-center gap-2 rounded-md bg-indigo-600 px-4 py-2 text-sm font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 disabled:opacity-50"
                :disabled="!oauth || oauth.connecting"
                x-on:click="oauth.start()">
                <i data-lucide="key-round" class="h-4 w-4"></i>
                <span x-text="oauth.connecting ? 'Starting…' : 'Connect with OAuth 2.0'"></span>
              </button>
              <button
                type="button"
                class="inline-flex items-center gap-2 rounded-md border border-gray-200 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50"
                :disabled="!oauth || oauth.status !== 'connected' || oauth.revoking"
                x-on:click="oauth.revoke()">
                <i data-lucide="shield-off" class="h-4 w-4"></i>
                <span x-text="oauth.revoking ? 'Revoking…' : 'Disconnect'"></span>
              </button>
            </div>
            <p class="text-xs text-indigo-700" x-show="oauth && oauth.status === 'connected' && oauth.expires_at">
              Token expires at <span class="font-mono" x-text="oauth.expires_at"></span>
            </p>
            <p class="text-xs text-amber-600" x-show="oauth && oauth.error" x-text="oauth.error"></p>
          </div>
        </div>
      </template>
    </div>
  </div>


  {% if form.allow_commands %}
    <div class="rounded-lg border border-blue-100 bg-blue-50 px-4 py-3 text-sm text-blue-700">
        Provide either a command or a URL. Expand the sections below to configure connection details and advanced options.
    </div>
  {% endif %}

  <div class="space-y-3">
    {% if form.allow_commands %}
      <details class="rounded-lg border border-gray-200 bg-white px-4 py-3" {% if form.command.value or form.command.errors %}open{% endif %}>
        <summary class="flex items-center justify-between cursor-pointer text-sm font-semibold text-gray-700">
          Command
          <span class="text-xs font-normal text-gray-400">Optional</span>
        </summary>
        <div class="mt-3 space-y-1">
          <label class="sr-only" for="{{ form.command.id_for_label }}">Command</label>
          {{ form.command }}
          {% if form.command.help_text %}
            <p class="text-xs text-gray-500">{{ form.command.help_text }}</p>
          {% endif %}
          {% for error in form.command.errors %}
            <p class="text-xs text-red-600">{{ error }}</p>
          {% endfor %}
        </div>
      </details>
    {% endif %}

    <details class="rounded-lg border border-gray-200 bg-white px-4 py-3" open>
      <summary class="flex items-center justify-between cursor-pointer text-sm font-semibold text-gray-700">
        URL
      </summary>
      <div class="mt-3 space-y-1">
        <label class="sr-only" for="{{ form.url.id_for_label }}">URL</label>
        {{ form.url }}
        {% if form.url.help_text %}
          <p class="text-xs text-gray-500">{{ form.url.help_text }}</p>
        {% endif %}
        {% for error in form.url.errors %}
          <p class="text-xs text-red-600">{{ error }}</p>
        {% endfor %}
      </div>
    </details>

    {% if form.allow_commands %}
      {% with value=form.command_args.value|stringformat:"s" %}
      <details class="rounded-lg border border-gray-200 bg-white px-4 py-3" {% if form.command_args.errors or value and value != '[]' %}open{% endif %}>
        <summary class="flex items-center justify-between cursor-pointer text-sm font-semibold text-gray-700">
          Command Arguments
          <span class="text-xs font-normal text-gray-400">Optional</span>
        </summary>
        <div class="mt-3 space-y-1">
          <label class="sr-only" for="{{ form.command_args.id_for_label }}">Command Arguments</label>
          {{ form.command_args }}
          {% if form.command_args.help_text %}
            <p class="text-xs text-gray-500">{{ form.command_args.help_text }}</p>
          {% endif %}
          {% for error in form.command_args.errors %}
            <p class="text-xs text-red-600">{{ error }}</p>
          {% endfor %}
        </div>
      </details>
      {% endwith %}
    {% endif %}

    {% if form.allow_commands %}
      {% with value=form.metadata.value|stringformat:"s" %}
      <details class="rounded-lg border border-gray-200 bg-white px-4 py-3" {% if form.metadata.errors or value and value != '{}' %}open{% endif %}>
        <summary class="flex items-center justify-between cursor-pointer text-sm font-semibold text-gray-700">
          Metadata
          <span class="text-xs font-normal text-gray-400">Optional</span>
        </summary>
        <div class="mt-3 space-y-1">
          <label class="sr-only" for="{{ form.metadata.id_for_label }}">Metadata</label>
          {{ form.metadata }}
          {% if form.metadata.help_text %}
            <p class="text-xs text-gray-500">{{ form.metadata.help_text }}</p>
          {% endif %}
          {% for error in form.metadata.errors %}
            <p class="text-xs text-red-600">{{ error }}</p>
          {% endfor %}
        </div>
      </details>
      {% endwith %}
    {% endif %}

    {% if form.allow_commands %}
      {% with value=form.environment.value|stringformat:"s" %}
      <details class="rounded-lg border border-gray-200 bg-white px-4 py-3" {% if form.environment.errors or value and value != '{}' %}open{% endif %}>
        <summary class="flex items-center justify-between cursor-pointer text-sm font-semibold text-gray-700">
          <span>Environment</span>
          <span class="flex items-center gap-2">
            <span class="inline-flex items-center gap-1 rounded-full bg-amber-100 px-2 py-0.5 text-[11px] font-semibold uppercase tracking-wide text-amber-700">
              <i data-lucide="lock" class="h-3 w-3"></i>
              Encrypted
            </span>
            <span class="text-xs font-normal text-gray-400">Optional</span>
          </span>
        </summary>
        <div class="mt-3 space-y-1">
          <label class="sr-only" for="{{ form.environment.id_for_label }}">Environment</label>
          {{ form.environment }}
          {% if form.environment.help_text %}
            <p class="text-xs text-gray-500">{{ form.environment.help_text }}</p>
          {% endif %}
          {% for error in form.environment.errors %}
            <p class="text-xs text-red-600">{{ error }}</p>
          {% endfor %}
        </div>
      </details>
      {% endwith %}
    {% endif %}

    {% with value=form.headers.value|stringformat:"s" %}
    <details class="rounded-lg border border-gray-200 bg-white px-4 py-3" open>
      <summary class="flex items-center justify-between cursor-pointer text-sm font-semibold text-gray-700">
        <span>Headers</span>
        <span class="inline-flex items-center gap-1 rounded-full bg-amber-100 px-2 py-0.5 text-[11px] font-semibold uppercase tracking-wide text-amber-700">
          <i data-lucide="lock" class="h-3 w-3"></i>
          Encrypted
        </span>
      </summary>
      <div class="mt-3 space-y-3">
        {{ form.headers }}
        <div class="space-y-3">
          <template x-for="(entry, index) in headers" :key="index">
            <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:gap-4">
              <div class="sm:flex-1 space-y-1">
                <label class="block text-xs font-medium text-gray-500">Header</label>
                <input
                  type="text"
                  class="py-2 px-3 block w-full border-gray-300 rounded-lg focus:border-blue-500 focus:ring-blue-500"
                  placeholder="X-Custom-Header"
                  x-model="headers[index].key"
                  x-on:input="syncHeadersField()" />
              </div>
              <div class="sm:flex-1 space-y-1">
                <label class="block text-xs font-medium text-gray-500">Value</label>
                <input
                  type="text"
                  class="py-2 px-3 block w-full border-gray-300 rounded-lg focus:border-blue-500 focus:ring-blue-500"
                  placeholder="Header value"
                  x-model="headers[index].value"
                  x-on:input="syncHeadersField()" />
              </div>
              <div class="sm:w-auto sm:self-end">
                <button
                  type="button"
                  class="inline-flex items-center gap-1 rounded-lg border border-gray-200 px-3 py-2 text-sm text-gray-600 hover:bg-gray-50"
                  x-on:click="removeHeaderRow(index)">
                  <i data-lucide="trash-2" class="h-4 w-4"></i>
                  Remove
                </button>
              </div>
            </div>
          </template>
        </div>
        <button
          type="button"
          class="inline-flex items-center gap-2 text-sm font-medium text-blue-600 hover:text-blue-700"
          x-on:click="addHeaderRow()">
          <i data-lucide="plus" class="h-4 w-4"></i>
          Add Header
        </button>
        {% if form.headers.help_text %}
          <p class="text-xs text-gray-500">{{ form.headers.help_text }}</p>
        {% endif %}
        {% for error in form.headers.errors %}
          <p class="text-xs text-red-600">{{ error }}</p>
        {% endfor %}
      </div>
    </details>
    {% endwith %}
  </div>
</form>
{% endwith %}
