{% extends "base.html" %}
{% load static %}
{% load agent_extras %}

{% block global_header %}{% endblock %}
{% block global_footer %}{% endblock %}

{% block content %}
<main class="min-h-screen bg-slate-50">
  <div class="mx-auto flex min-h-screen w-full flex-col gap-6 px-4 pb-0 pt-6 sm:px-6 lg:px-10">

      <div id="agent-workspace-root"
         class="relative flex flex-1 flex-col gap-4"
         data-timeline-limit="{{ timeline_limit }}"
         data-timeline-newer-url="{{ timeline_newer_url }}"
         data-timeline-window-url="{{ timeline_window_url }}"
         data-timeline-older-url="{{ timeline_older_url }}"
         data-event-stream-url="{{ event_stream_url }}"
         data-processing-status-url="{{ processing_status_url }}"
         data-processing-active="{{ processing_active|yesno:'true,false' }}"
         data-web-session-url="{{ web_session_url }}"
         data-web-session-ttl="{{ web_session_ttl }}"
         data-agent-first-name="{{ agent_first_name }}">

      <div id="timeline-shell" class="relative flex-1">
        <div id="timeline-events" class="flex h-full flex-col gap-3 overflow-y-auto">
          <div id="timeline-load-older" class="timeline-load-control border-b border-slate-100" data-side="older" data-state="{{ timeline_has_more_older|yesno:'has-more,exhausted' }}">
            <button type="button"
                    data-role="load-older-button"
                    data-direction="older"
                    data-action="timeline-fetch"
                    data-url="{{ timeline_older_url }}"
                    data-target="#timeline-event-list"
                    data-swap="afterbegin"
                    class="timeline-load-button"
                    {% if not timeline_has_more_older %}hidden{% endif %}>
              <span class="timeline-load-indicator" aria-hidden="true"></span>
              <span class="timeline-load-label">Load older</span>
            </button>
            <span data-role="history-start"
                  class="timeline-history-label"
                  {% if timeline_has_more_older %}hidden{% endif %}>
              Beginning of history
            </span>
          </div>
          <div id="timeline-event-list" class="flex flex-col gap-3">
            {% include "console/partials/_agent_timeline_items.html" with events=timeline_window.events agent_first_name=agent_first_name suppress_empty=suppress_empty %}
          </div>
          <div id="processing-indicator-slot" class="processing-slot" data-visible="false"></div>
          <div id="timeline-load-newer" class="timeline-load-control border-t border-slate-100" data-side="newer" data-state="{{ timeline_has_more_newer|yesno:'has-more,exhausted' }}" {% if not timeline_has_more_newer %}hidden{% endif %}>
            <button type="button"
                    data-role="load-newer-button"
                    data-direction="newer"
                    data-action="timeline-fetch"
                    data-url="{{ timeline_newer_url }}"
                    data-target="#timeline-event-list"
                    data-swap="beforeend"
                    class="timeline-load-button"
                    {% if not timeline_has_more_newer %}hidden{% endif %}>
              <span class="timeline-load-indicator" aria-hidden="true"></span>
              <span class="timeline-load-label">Load newer</span>
            </button>
          </div>
        </div>
      </div>

      <div id="timeline-cursors" class="hidden"
           data-older="{{ timeline_oldest_cursor|default:'' }}"
           data-newer="{{ timeline_newest_cursor|default:'' }}"
           data-has-more-older="{{ timeline_has_more_older|yesno:'true,false' }}"
           data-has-more-newer="{{ timeline_has_more_newer|yesno:'true,false' }}"
           data-processing-active="{{ processing_active|yesno:'true,false' }}"
           data-direction="initial"
           data-mode="snapshot"></div>

      <div id="agent-composer-shell" class="composer-shell">
        <div class="composer-surface">
          <form id="agent-web-compose" class="flex flex-col" hx-post="{% url 'agent_web_message' agent.id %}" hx-swap="none">
            <div class="composer-input-surface flex flex-col gap-2 rounded-2xl border border-slate-200/70 bg-white px-4 py-3 transition">
              <textarea name="body" rows="1" required
                        class="block w-full resize-none border-0 bg-transparent px-0 py-1 text-sm leading-5 text-slate-800 placeholder:text-slate-400 focus:outline-none focus:ring-0 min-h-[1.8rem]"
                        placeholder="Send a message..."></textarea>
              <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                <div class="flex flex-col gap-1.5 text-xs text-slate-500 sm:flex-row sm:items-center sm:gap-3.5">
                  <div class="text-[0.75rem] text-slate-500 sm:text-sm">
                    <span class="text-slate-400">To:</span>
                    <span class="ml-1 font-medium text-slate-900">{{ agent.name }}</span>
                  </div>
                </div>
                <button type="submit"
                        class="composer-send-button">
                  Send
                </button>
              </div>
            </div>
            <input type="hidden" name="current_newest" id="composer-latest-cursor" value="{{ timeline_window.window_newest_cursor|default:'' }}">
          </form>
        </div>
      </div>
    </div>
  </div>
</main>
<button id="jump-to-latest" class="jump-to-latest hidden" type="button" aria-label="Jump to latest" aria-hidden="true" style="display:none;opacity:0">
  <svg aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 5v14m0 0-5-5m5 5 5-5" />
  </svg>
  <span class="sr-only">Jump to latest</span>
</button>
<div id="processing-state" class="hidden" style="display:none" data-processing-active="{{ processing_active|yesno:'true,false' }}"></div>
{% endblock %}

{% block extra_js %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<link rel="stylesheet" href="{% static 'css/agent_workspace.css' %}">
<script src="{% static 'js/agent_workspace.js' %}"></script>
{% endblock %}
